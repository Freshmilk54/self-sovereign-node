<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Self-Node 控制台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- 建議用 Flask 的 url_for，避免之後改 static 路徑爆掉 -->
  <link href="{{ url_for('static', filename='app.css') }}" rel="stylesheet">
</head>
<body class="p-4">
  <h3 class="mb-2">Self-Node 控制台</h3>
  <div class="text-muted small mb-3">
    最後更新：<span id="last">--:--:--</span>
  </div>

  <div id="err" class="text-danger small mb-2" style="display:none;"></div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>VPN 狀態</h5>
        <div id="vpn">載入中...</div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5>Nextcloud 使用量</h5>
        <div id="nc">載入中...</div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5>IPFS 狀態</h5>
        <div id="ipfs">載入中...</div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h5>最近登入紀錄</h5>
        <pre id="logins">載入中...</pre>
      </div>
    </div>
  </div>

<script>
function esc(s){
  return String(s || "").replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

function renderPeers(peers){
  if(!peers || peers.length === 0)
    return '<div class="text-muted">無 peer</div>';

  return `
    <div class="peer-list">
      ${peers.map(p => `
        <div class="peer-item${(p.handshake || '').includes('minute') ? ' stale' : ''}">
          <div><span class="k">peer</span>: <code>${esc(p.peer)}</code></div>
          ${p.endpoint ? `<div><span class="k">endpoint</span>: <code>${esc(p.endpoint)}</code></div>` : ""}
          ${p.allowed_ips ? `<div class="text-truncate"><span class="k">allowed</span>: <code>${esc(p.allowed_ips)}</code></div>` : ""}
          ${p.handshake ? `<div><span class="k">handshake</span>: <code>${esc(p.handshake)}</code></div>` : ""}
          ${p.transfer ? `<div><span class="k">transfer</span>: <code>${esc(p.transfer)}</code></div>` : ""}
        </div>
      `).join("")}
    </div>`;
}

function renderLogins(lines){
  if(!lines || lines.length === 0)
    return '<div class="text-muted">no data</div>';

  return `
    <ul class="login-list">
      ${lines.map(l => `<li><code>${esc(l)}</code></li>`).join("")}
    </ul>`;
}

async function refresh(){
  const errBox = document.getElementById("err");
  errBox.style.display = "none";
  errBox.textContent = "";

  try {
    const r = await fetch("/api/status", {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP " + r.status);
    const d = await r.json();

    const vpn = d.vpn || {};
    const nc  = d.nextcloud || {};
    const ipf = d.ipfs || {};
    const lg  = d.logins || {};

    // VPN 卡
    document.getElementById("vpn").innerHTML =
      (vpn.raw_ok
        ? `<div><b>${vpn.up ? "連線中" : "未啟用"}</b></div>${renderPeers(vpn.peers)}`
        : `<div class="text-danger">無法取得 VPN 狀態</div>${vpn.error ? "<pre>"+esc(vpn.error)+"</pre>" : ""}`
      );

    // Nextcloud 卡
    document.getElementById("nc").innerHTML =
      nc.raw_ok
        ? `Installed: <b>${nc.installed}</b><br>
           Version: <b>${esc(nc.version)}</b><br>
           Data usage: <b>${esc(nc.data_usage)}</b>`
        : `<div class="text-danger">無法取得 Nextcloud 狀態</div>`;

    // IPFS 卡
    document.getElementById("ipfs").innerHTML =
      ipf.raw_ok
        ? `Online: <b>${ipf.online}</b><br>
           Peer ID: <code>${esc(ipf.peer_id) || "-"}</code><br>
           Peers: <b>${ipf.peers}</b><br>
           Repo size: <b>${esc(ipf.repo_size)}</b>`
        : `<div class="text-danger">無法取得 IPFS 狀態</div>`;

    // Login 卡
    document.getElementById("logins").innerHTML = renderLogins(lg.entries);

    document.getElementById("last").textContent =
      new Date().toLocaleTimeString();
  } catch (e) {
    errBox.textContent = "載入狀態失敗：" + e;
    errBox.style.display = "block";
  }
}

refresh();
setInterval(refresh, 8000);
</script>

</body>
</html>
